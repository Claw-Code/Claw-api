# Fixed local development Dockerfile with proper bcrypt compilation
FROM node:18-bullseye

# Install system dependencies including build tools for native modules
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    git \
    curl \
    bash \
    wget \
    netcat-openbsd \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install wait-for-it script
RUN wget https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh \
    && chmod +x wait-for-it.sh \
    && mv wait-for-it.sh /usr/local/bin/

# Copy package files first
COPY package*.json ./
COPY .npmrc ./

# Install dependencies and rebuild native modules in container
RUN npm install --legacy-peer-deps && \
    npm rebuild bcrypt --build-from-source && \
    npm cache clean --force

# Copy source code
COPY . .

# Create workspace and logs directories
RUN mkdir -p workspace/downloads logs

# Create startup script that waits for external MongoDB
RUN cat > /app/start-local.sh << 'EOF'
#!/bin/bash
set -e

echo "🚀 Starting Claw API (waiting for external MongoDB)..."

# Rebuild bcrypt to ensure compatibility
echo "🔧 Rebuilding native modules..."
npm rebuild bcrypt --build-from-source

# Wait for MongoDB to be ready
echo "⏳ Waiting for MongoDB at ${MONGODB_HOST:-mongodb-local}:${MONGODB_PORT:-27017}..."
wait-for-it.sh ${MONGODB_HOST:-mongodb-local}:${MONGODB_PORT:-27017} --timeout=60 --strict

echo "✅ MongoDB is ready!"

# Start the application
echo "🌟 Starting API server..."
npm run dev
EOF

RUN chmod +x /app/start-local.sh

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

# Start services
CMD ["/app/start-local.sh"]
